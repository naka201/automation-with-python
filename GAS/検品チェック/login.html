<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>ログイン</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f5f5f5;
      }
      .login-container {
        width: 100%;
        max-width: 400px;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        position: relative; /* For spinner positioning */
      }
      .login-title {
        text-align: center;
        margin-bottom: 20px;
      }
      #errorMessage {
        display: none;
        margin-top: 15px;
      }
      .spinner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.7);
        z-index: 10;
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
      }
      .spinner-border {
         width: 3rem;
         height: 3rem;
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <div id="spinner" class="spinner-overlay">
        <div>
          <div class="spinner-border text-primary" role="status"></div>
          <div class="mt-2">ログイン中...</div>
        </div>
      </div>
      <h2 class="login-title">検品管理システム ログイン</h2>
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="username">アカウント名</label>
          <input type="text" class="form-control" id="username" required>
        </div>
        <div class="form-group">
          <label for="password">パスワード</label>
          <input type="password" class="form-control" id="password" required>
        </div>
        <button type="submit" id="loginButton" class="btn btn-primary btn-block">ログイン</button>
      </form>
      <div id="errorMessage" class="alert alert-danger" role="alert"></div>
    </div>

    <script>
      function handleLogin(event) {
        event.preventDefault(); // Prevent form submission

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const errorMessageDiv = document.getElementById('errorMessage');
        const spinner = document.getElementById('spinner');
        const loginButton = document.getElementById('loginButton');

        if (!username || !password) {
          errorMessageDiv.textContent = 'アカウント名とパスワードを入力してください。';
          errorMessageDiv.style.display = 'block';
          return;
        }

        // Show spinner and disable button
        spinner.style.display = 'flex';
        loginButton.disabled = true;
        errorMessageDiv.style.display = 'none';

        google.script.run
          .withSuccessHandler(function(isSuccess) {
            if (isSuccess) {
              document.getElementById('spinner').innerHTML = '<div><div class="spinner-border text-primary" role="status"></div><div class="mt-2">検品画面を読み込んでいます...</div></div>';
              // ★★★ 修正点 ★★★
              // トップウィンドウをウェブアプリのURLにリダイレクトさせる
              window.top.location.href = "<?= ScriptApp.getService().getUrl() ?>";
            } else {
              errorMessageDiv.textContent = 'アカウント名またはパスワードが正しくありません。';
              errorMessageDiv.style.display = 'block';
              // Hide spinner and re-enable button
              spinner.style.display = 'none';
              loginButton.disabled = false;
            }
          })
          .withFailureHandler(function(error) {
            errorMessageDiv.textContent = 'エラーが発生しました: ' + error.message;
            errorMessageDiv.style.display = 'block';
            // Hide spinner and re-enable button
            spinner.style.display = 'none';
            loginButton.disabled = false;
          })
          .checkLogin(username, password);
      }
    </script>
  </body>
</html>